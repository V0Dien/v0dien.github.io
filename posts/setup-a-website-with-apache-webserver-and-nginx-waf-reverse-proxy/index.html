<!DOCTYPE html><html lang="en" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.7.2"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Set up website with apache webserver and nginx waf reverse proxy" /><meta name="author" content="F4c3l3ss_" /><meta property="og:locale" content="en_US" /><meta name="description" content="When I started thinking about running my site on my own server instead of using Blogger or Medium, etc… And after tried to use Apache, Nginx,… I realized that combining Apache and Nginx could be the best choice for me, because I want to use .htaccess of Apache and speed of Nginx. There come my architecture:" /><meta property="og:description" content="When I started thinking about running my site on my own server instead of using Blogger or Medium, etc… And after tried to use Apache, Nginx,… I realized that combining Apache and Nginx could be the best choice for me, because I want to use .htaccess of Apache and speed of Nginx. There come my architecture:" /><link rel="canonical" href="https://v0dien.github.io/posts/setup-a-website-with-apache-webserver-and-nginx-waf-reverse-proxy/" /><meta property="og:url" content="https://v0dien.github.io/posts/setup-a-website-with-apache-webserver-and-nginx-waf-reverse-proxy/" /><meta property="og:site_name" content="Vô Diện (@F4c3l3ss_)" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-04-03T00:00:00+07:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Set up website with apache webserver and nginx waf reverse proxy" /><meta name="twitter:site" content="@F4c3l3ss_" /><meta name="twitter:creator" content="@F4c3l3ss_" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"F4c3l3ss_"},"description":"When I started thinking about running my site on my own server instead of using Blogger or Medium, etc… And after tried to use Apache, Nginx,… I realized that combining Apache and Nginx could be the best choice for me, because I want to use .htaccess of Apache and speed of Nginx. There come my architecture:","headline":"Set up website with apache webserver and nginx waf reverse proxy","dateModified":"2020-04-03T00:00:00+07:00","datePublished":"2020-04-03T00:00:00+07:00","url":"https://v0dien.github.io/posts/setup-a-website-with-apache-webserver-and-nginx-waf-reverse-proxy/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://v0dien.github.io/posts/setup-a-website-with-apache-webserver-and-nginx-waf-reverse-proxy/"},"@context":"https://schema.org"}</script><title>Set up website with apache webserver and nginx waf reverse proxy | Vô Diện (@F4c3l3ss_)</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/sample/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Vô Diện (@F4c3l3ss_)</a></div><div class="site-subtitle font-italic">Hi! 👻</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tabs/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tabs/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/tabs/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tabs/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/V0Dien" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/F4c3l3ss_" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['v0dien','outlook.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Set up website with apache webserver and nginx waf reverse proxy</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Set up website with apache webserver and nginx waf reverse proxy</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Fri, Apr 3, 2020, 12:00 AM +0700" > Apr 3, 2020 <i class="unloaded">2020-04-03T00:00:00+07:00</i> </span> by <span class="author"> F4c3l3ss_ </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="846 words">4 min</span></div></div><div class="post-content"><p>When I started thinking about running my site on my own server instead of using Blogger or Medium, etc… And after tried to use Apache, Nginx,… I realized that combining Apache and Nginx could be the best choice for me, because I want to use <code class="language-plaintext highlighter-rouge">.htaccess</code> of Apache and speed of Nginx. There come my architecture:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/blog/Diagram.jpg" alt="IMG" /></p><p>In this post, I will use private IP range for Nginx reverse proxy server and Apache web server. Both of them are running Ubuntu 18.04 LTS.</p><ul><li><p>Apache webserver: 10.128.0.2</p><li><p>Nginx reverse proxy: 10.128.0.3</p></ul><h1 id="1-install-and-configure-apache-web-server">1. Install and configure Apache web server</h1><p>Install apache webserver:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo </span>apt <span class="nb">install </span>apache2
</pre></table></code></div></div><p>Next we create a place where to storage source code:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo mkdir</span> <span class="nt">-p</span> /var/www/html/example.com/public_html
</pre></table></code></div></div><p>Change permission:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo chown</span> <span class="nt">-R</span> &lt;user&gt;:&lt;group&gt; /var/www/html/example.com/public_html
<span class="nv">$ </span><span class="nb">sudo chmod</span> <span class="nt">-R</span> 744 /var/www/html/example.com/public_html
</pre></table></code></div></div><p>With <strong>user</strong> and <em>*group</em> you can use command</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>apachectl <span class="nt">-S</span>
</pre></table></code></div></div><p>Usually, it’s www-data</p><p>Now let’s config virutal host and port:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo </span>vim /etc/apache2/ports.conf

Listen 8080

&lt;IfModule ssl_module&gt;
        Listen 443
&lt;/IfModule&gt;

&lt;IfModule mod_gnutls.c&gt;
        Listen 443
&lt;/IfModule&gt;

<span class="nv">$ </span><span class="nb">sudo cp</span> /etc/apache2/sites-available/000-default.conf /etc/apache2/sites-available/example.com.conf
<span class="nv">$ </span><span class="nb">sudo </span>vim /etc/apache2/sites-available/example.com.conf

&lt;VirtualHost 10.128.0.2:8080&gt;
        ServerAdmin webmaster@example.com
        DocumentRoot /var/www/html/example.com/public_html/

        ErrorLog <span class="k">${</span><span class="nv">APACHE_LOG_DIR</span><span class="k">}</span>/error.log
        CustomLog <span class="k">${</span><span class="nv">APACHE_LOG_DIR</span><span class="k">}</span>/access.log combined
        ErrorDocument 404 /404.html
&lt;/VirtualHost&gt;
</pre></table></code></div></div><p>Active your website:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo </span>a2dissite 000-default.conf
<span class="nv">$ </span><span class="nb">sudo </span>a2ensite example.com.conf
</pre></table></code></div></div><h1 id="2-install-and-configure-nginx">2. Install and configure Nginx</h1><h2 id="21-install-nginx-package">2.1 Install Nginx package</h2><p>Install the prerequisites:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo </span>apt <span class="nb">install </span>curl gnupg2 ca-certificates lsb-release
</pre></table></code></div></div><p>Add repository for stable nginx packages:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"deb http://nginx.org/packages/ubuntu </span><span class="sb">`</span>lsb_release <span class="nt">-cs</span><span class="sb">`</span><span class="s2"> nginx"</span> <span class="se">\</span>
    | <span class="nb">sudo tee</span> /etc/apt/sources.list.d/nginx.list
</pre></table></code></div></div><p>Import an official nginx signing key so apt could verify the packages authenticity:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>curl <span class="nt">-fsSL</span> https://nginx.org/keys/nginx_signing.key | <span class="nb">sudo </span>apt-key add -
</pre></table></code></div></div><p>Verify that you now have the proper key:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo </span>apt-key fingerprint ABF5BD827BD9BF62
</pre></table></code></div></div><p>The output should contain the full fingerprint 573B FD6B 3D8F BC64 1079 A6AB ABF5 BD82 7BD9 BF62 as follows:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>pub   rsa2048 2011-08-19 <span class="o">[</span>SC] <span class="o">[</span>expires: 2024-06-14]
      573B FD6B 3D8F BC64 1079  A6AB ABF5 BD82 7BD9 BF62
uid   <span class="o">[</span> unknown] nginx signing key &lt;signing-key@nginx.com&gt;
</pre></table></code></div></div><p>Finally, install Nginx:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo </span>apt update
<span class="nv">$ </span><span class="nb">sudo </span>apt <span class="nb">install </span>nginx
</pre></table></code></div></div><h2 id="22-configure-nginx-reverse-proxy">2.2 Configure Nginx reverse proxy</h2><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo cp</span> /etc/nginx/conf.d/default.conf /etc/nginx/conf.d/example.com.conf
<span class="nv">$ </span><span class="nb">sudo </span>vim /etc/nginx/conf.d/example.com.conf
server <span class="o">{</span>

    listen       80<span class="p">;</span>
    server_name example.com<span class="p">;</span>
	port_in_redirect off<span class="p">;</span>

    location / <span class="o">{</span>
        proxy_redirect off<span class="p">;</span>
        proxy_set_header Host <span class="nv">$host</span>:<span class="nv">$server_port</span><span class="p">;</span>
        proxy_set_header X-Forwarded-Host <span class="nv">$http_host</span><span class="p">;</span>
        proxy_set_header X-Real-IP <span class="nv">$remote_addr</span><span class="p">;</span>
        proxy_set_header X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
        proxy_pass http://10.128.0.2:8080<span class="p">;</span>
    <span class="o">}</span>

    location ~ /<span class="se">\.</span>ht <span class="o">{</span>
        deny  all<span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="23-install-and-configure-modsecurity">2.3 Install and configure Modsecurity</h2><p>Install the prerequisites:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> apt-utils autoconf automake build-essential git libcurl4-openssl-dev libgeoip-dev liblmdb-dev libpcre++-dev libtool libxml2-dev libyajl-dev pkgconf wget zlib1g-dev
</pre></table></code></div></div><p>Download Modsecurity source:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>git clone <span class="nt">--depth</span> 1 <span class="nt">-b</span> v3/master <span class="nt">--single-branch</span> https://github.com/SpiderLabs/ModSecurity
</pre></table></code></div></div><p>Compile Modsecurity:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">cd </span>ModSecurity
<span class="nv">$ </span>git submodule init
<span class="nv">$ </span>git submodule update
<span class="nv">$ </span>./build.sh
<span class="nv">$ </span>./configure
<span class="nv">$ </span>make
<span class="nv">$ </span><span class="nb">sudo </span>make <span class="nb">install</span>
</pre></table></code></div></div><p>If you see this notification on your terminal, just ignore it and take a coffee because the process might take about 15 minutes to complete.</p><blockquote><p>fatal: No names found, cannot describe anything.</p></blockquote><h2 id="24-download-the-nginx-connector-for-modsecurity-and-compile-it-as-a-dynamic-module">2.4 Download the NGINX Connector for ModSecurity and Compile It as a Dynamic Module</h2><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>git clone <span class="nt">--depth</span> 1 https://github.com/SpiderLabs/ModSecurity-nginx.git
</pre></table></code></div></div><p>Check your nginx version:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">$ </span>nginx <span class="nt">-v</span>

nginx version: nginx/1.17.9
</pre></table></code></div></div><p>Download source code:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">cd </span>nginx-1.17.9
<span class="nv">$ </span>./configure <span class="nt">--with-compat</span> <span class="nt">--add-dynamic-module</span><span class="o">=</span>../ModSecurity-nginx
<span class="nv">$ </span>make modules
<span class="nv">$ </span><span class="nb">sudo cp </span>objs/ngx_http_modsecurity_module.so /etc/nginx/modules/
</pre></table></code></div></div><p>Load Nginx Modsecurity Connector by add the load_module following to the top of <code class="language-plaintext highlighter-rouge">/etc/nginx/nginx.conf</code></p><blockquote><p>load_module modules/ngx_http_modsecurity_module.so;</p></blockquote><p>Configure and Enable Modsecurity:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo mkdir</span> /etc/nginx/modsec
<span class="nv">$ </span><span class="nb">sudo </span>wget <span class="nt">-P</span> /etc/nginx/modsec/ https://raw.githubusercontent.com/SpiderLabs/ModSecurity/v3/master/modsecurity.conf-recommended
<span class="nv">$ </span><span class="nb">sudo mv</span> /etc/nginx/modsec/modsecurity.conf-recommended /etc/nginx/modsec/modsecurity.conf
</pre></table></code></div></div><p>Active dropping malicious mode:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo sed</span> <span class="nt">-i</span> <span class="s1">'s/SecRuleEngine DetectionOnly/SecRuleEngine On/'</span> /etc/nginx/modsec/modsecurity.conf
</pre></table></code></div></div><p>Add modsecurity rule and config your test rule:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo </span>vim /etc/nginx/modsec/main.conf

Include <span class="s2">"/etc/nginx/modsec/modsecurity.conf"</span>

<span class="c"># Basic test rule</span>

SecRule ARGS:testparam <span class="s2">"@contains test"</span> <span class="s2">"id:1234,deny,status:403"</span>
</pre></table></code></div></div><p>Then turn on the modsecurity in your server config:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo </span>vim /etc/nginx/conf.d/example.com.conf

server <span class="o">{</span>
    <span class="c"># ...</span>
    modsecurity on<span class="p">;</span>
    modsecurity_rules_file /etc/nginx/modsec/main.conf<span class="p">;</span>
<span class="o">}</span>
</pre></table></code></div></div><p>Check everything ok yet by command:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo </span>nginx <span class="nt">-t</span>
</pre></table></code></div></div><p>If the output are:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
</pre></table></code></div></div><p>We completed 99%, if there is an error about unicode.mapping, you can fix it by the following commands:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">cd</span> /path/to/Modsecurity
<span class="nv">$ </span><span class="nb">sudo cp </span>unicode.mapping /etc/nginx/modsec/
</pre></table></code></div></div><p>Check if the waf is active or not by curl. The <code class="language-plaintext highlighter-rouge">403</code> status confirmed that the rule worked:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="nv">$ </span>curl example.com/?testparam<span class="o">=</span><span class="nb">test</span>
&lt;html&gt;
&lt;<span class="nb">head</span><span class="o">&gt;</span>&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;
&lt;body <span class="nv">bgcolor</span><span class="o">=</span><span class="s2">"white"</span><span class="o">&gt;</span>
&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx/1.13.1&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre></table></code></div></div><p>This is the basic configuration, if you have any problem, just let me know and I will help you!</p><p>Cheers!</p><p>P/S: Thank you GinaTU aka Tứ Diệp Thảo to help me edit this post</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/research/'>Research</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/nginx/" class="post-tag no-text-decoration" >nginx</a> <a href="/tags/forensics/" class="post-tag no-text-decoration" >forensics</a> <a href="/tags/apache/" class="post-tag no-text-decoration" >apache</a> <a href="/tags/webserver/" class="post-tag no-text-decoration" >webserver</a> <a href="/tags/system/" class="post-tag no-text-decoration" >system</a> <a href="/tags/waf/" class="post-tag no-text-decoration" >waf</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Set up website with apache webserver and nginx waf reverse proxy - Vô Diện (@F4c3l3ss_)&url=https://v0dien.github.io/posts/setup-a-website-with-apache-webserver-and-nginx-waf-reverse-proxy/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Set up website with apache webserver and nginx waf reverse proxy - Vô Diện (@F4c3l3ss_)&u=https://v0dien.github.io/posts/setup-a-website-with-apache-webserver-and-nginx-waf-reverse-proxy/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Set up website with apache webserver and nginx waf reverse proxy - Vô Diện (@F4c3l3ss_)&url=https://v0dien.github.io/posts/setup-a-website-with-apache-webserver-and-nginx-waf-reverse-proxy/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Decompile-va-Recompile-APK/">Decompile và Recompile ứng dụng APK</a><li><a href="/posts/USB-PCAP-P1-Keyboard/">USB PCAP - Phần 1 Bàn phím</a><li><a href="/posts/Writeup-Dien-tap-ATTT-NHNN-03-2021/">[Writeup] Diễn tập ATTT Ngân hàng Nhà Nước 31/03/2021</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/writeup/">writeup</a> <a class="post-tag" href="/tags/forensics/">forensics</a> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/research/">research</a> <a class="post-tag" href="/tags/hackthebox/">hackthebox</a> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/apache/">apache</a> <a class="post-tag" href="/tags/asis/">ASIS</a> <a class="post-tag" href="/tags/bsidessf/">BSidesSF</a> <a class="post-tag" href="/tags/cryptography/">cryptography</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Hexion-CTF-2020/"><div class="card-body"> <span class="timeago small" > Apr 13, 2020 <i class="unloaded">2020-04-13T00:00:00+07:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[Writeup] Hexion CTF 2020</h3><div class="text-muted small"><p> Mirate In this challenge, we will see the flag after being encrypted; when we type some words to the text box, we will receive the encrypted words corresponding with our input words. And here i...</p></div></div></a></div><div class="card"> <a href="/posts/Writeup-VNPT-Secathon-2018/"><div class="card-body"> <span class="timeago small" > Mar 20, 2018 <i class="unloaded">2018-03-20T00:00:00+07:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[Writeup] VPNT Secathon 2018 - Misc</h3><div class="text-muted small"><p> Chayngaydi Trong bài này ban tổ chức cho chúng ta đoạn teaser trailer Chạy ngay đi của Sếp. Ngay khi nhìn vào dung lượng của tập tin mp4, thì mình biết chắc chắn rằng nó đang giấu một file gì đ...</p></div></div></a></div><div class="card"> <a href="/posts/Mates-SS2-Round-4-Forensics-caigidzay/"><div class="card-body"> <span class="timeago small" > May 1, 2018 <i class="unloaded">2018-05-01T00:00:00+07:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[Writeup] Mates SS2 Round 4 - Forensics caigidzay</h3><div class="text-muted small"><p> Trong thử thách này để bài là một file dump, mbr/dos nên mình sẽ dùng auto spy để mở nó xem sao. Đập vào mắt mình là flag.jpg. Mình tốn kha khá thời gian với bức ảnh này vì lúc đầu tưởng đây là ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Writeup-BSidesSF-2019-CTF/" class="btn btn-outline-primary"><p>[Writeup] BSidesSF 2019 CTF</p></a> <a href="/posts/Hexion-CTF-2020/" class="btn btn-outline-primary"><p>[Writeup] Hexion CTF 2020</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/F4c3l3ss_">Vô Diện (@F4c3l3ss_)</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/writeup/">writeup</a> <a class="post-tag" href="/tags/forensics/">forensics</a> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/research/">research</a> <a class="post-tag" href="/tags/hackthebox/">hackthebox</a> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/apache/">apache</a> <a class="post-tag" href="/tags/asis/">ASIS</a> <a class="post-tag" href="/tags/bsidessf/">BSidesSF</a> <a class="post-tag" href="/tags/cryptography/">cryptography</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script> <script> $(function() { let initTheme = "default"; if ($("html[mode=dark]").length > 0 || ($("html[mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://v0dien.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
